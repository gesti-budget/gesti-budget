cmake_minimum_required (VERSION 3.30 FATAL_ERROR)


# ---------------------------------------------------------------------------
# cmake/
# â”œâ”€â”€ Version.cmake                 # Gestion des versions (NEWS, suffixe instable)
# â”œâ”€â”€ GitInfo.cmake                 # Extraction des infos Git (branche, commit, date)
# â”œâ”€â”€ VcpkgSetup.cmake              # DÃ©tection et intÃ©gration automatique de vcpkg
# â”œâ”€â”€ BuildHeader.cmake             # GÃ©nÃ©ration du build.h
# â”œâ”€â”€ LinuxDetection.cmake          # DÃ©tection OS/distro Linux
# â”œâ”€â”€ CompilerSetup.cmake           # Configuration du compilateur et des outils de cache
# â”œâ”€â”€ CacheTool.cmake               # Configuration du cache de compilation (ccache/clcache)
# â”œâ”€â”€ PlatformPaths.cmake	        # DÃ©finition des chemins de ressources selon la plateforme
# â”œâ”€â”€ GraphVizExport.cmake          # Options pour l'export Graphviz des dÃ©pendances
# â”œâ”€â”€ WxWidgetsSetup.cmake          # Configuration de wxWidgets (si nÃ©cessaire)
# â”œâ”€â”€ CurlSetup.cmake               # Configuration de la dÃ©pendance CURL/libcurl
# â”œâ”€â”€ BuildLayout.cmake             # Configuration des chemins de build et ressources
# â”œâ”€â”€ PackagingSetup.cmake          # Configuration de l'archivage et packaging
# â”œâ”€â”€ CPackSetup.cmake              # Configuration de CPack pour les paquets multiplateformes
# â””â”€â”€ install.cmake                # Installation des fichiers gÃ©nÃ©rÃ©s (build.h, etc.)
# === Chargement des modules CMake personnalisÃ©s ===
list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/cmake") 


# ğŸ”¢ Gestion de la version du projet (extrait de NEWS)
include(Version)

# ğŸ“¦ DÃ©tection de vcpkg et configuration du toolchain
include(VcpkgSetup)


# === Configuration du format de debug pour Visual Studio (MSVC) ===
# Si la politique CMP0141 (CMake â‰¥ 3.28) est disponible,
# active le support du rechargement Ã  chaud (Edit & Continue) pour MSVC en Debug.
# Activez Rechargement Ã  chaud pour les compilateurs MSVC si cela est pris en charge.
if (POLICY CMP0141)
  cmake_policy(SET CMP0141 NEW)
  set(CMAKE_MSVC_DEBUG_INFORMATION_FORMAT "$<IF:$<AND:$<C_COMPILER_ID:MSVC>,$<CXX_COMPILER_ID:MSVC>>,$<$<CONFIG:Debug,RelWithDebInfo>:EditAndContinue>,$<$<CONFIG:Debug,RelWithDebInfo>:ProgramDatabase>>")
endif()

project (GBEX VERSION ${GBEX_VERSION})

# Options de configuration du projet
option(GBEX_PORTABLE_INSTALL "Inclure un fichier gbexini.db3 vide dans l'installation Windows (mode portable)" OFF)
option(GBEX_ENCRYPTION_OPTIONAL "Compiler mÃªme si la bibliothÃ¨que wxsqlite ne prend pas en charge le chiffrement" OFF)

# Nom du fichier exÃ©cutable gÃ©nÃ©rÃ©
set(GBEX_EXE gbex)

# ğŸ“ GÃ©nÃ©ration du fichier build.h (version + date/heure de build)
include(BuildHeader)

# ğŸ¯ RÃ©cupÃ©ration des infos Git (branche, commit, date)
include(GitInfo)


# ğŸ§ DÃ©tection de la distribution Linux (via lsb_release, etc.)
include(LinuxDetection)

# âš™ï¸ Configuration du compilateur (C++17/23, flags MSVC, AppleClang, etc.)
include(CompilerSetup)

# ğŸš€ DÃ©tection et configuration dâ€™un outil de cache de compilation
include(CacheTool)

# ğŸ“Š Configuration pour lâ€™export des dÃ©pendances au format Graphviz
include(GraphVizExport)

# ğŸ§± DÃ©finition des chemins vers ressources/doc selon la plateforme
include(PlatformPaths)

# ğŸ“š Chargement de la dÃ©pendance wxWidgets
include(WxWidgetsSetup)


# ğŸŒ Chargement de la dÃ©pendance libcurl (avec fallback avancÃ©)
include(CurlSetup)


add_subdirectory(3rd/fmt)

# ğŸ“¦ Mise en place de lâ€™arborescence de build et des rÃ©pertoires dâ€™installation
include(BuildLayout)

## Inclusion des sous-dossiers qui dÃ©clarent des cibles (executables, bibliothÃ¨ques) ##
add_subdirectory(3rd)
add_subdirectory(po)
add_subdirectory(src)

# ğŸ“¦ GÃ©nÃ©ration des packages de thÃ¨mes et rapports (zip .mmextheme/.grm)
include(PackagingSetup)

## Tuning for VisualStudio IDE ##
if(NOT CMAKE_VERSION VERSION_LESS 3.6)
    set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT ${GBEX_EXE})
endif()

# ğŸ“¦ Configuration de l'installation des fichiers gÃ©nÃ©rÃ©s et des ressources
include(install)

# ğŸ“¦ Configuration de CPack pour la crÃ©ation de paquets multiplateformes 
include(CPackSetup)

# TODO: Ajoutez des tests et installez des cibles si nÃ©cessaire.


# ---------------------------------------------------------------------------
# Affiche les difÃ©rentes informations du projet
include(ShowVar)